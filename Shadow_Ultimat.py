#  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
# ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë    ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ñà‚ïó ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë    ‚ñà‚ñà‚ïî‚ïù    ‚ñà‚ñà‚ïî‚ïù    ‚ñà‚ñà‚ïî‚ïù
#  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïî‚ïù    ‚ñà‚ñà‚ïî‚ïù    ‚ñà‚ñà‚ïî‚ïù
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ïù      ‚ñà‚ñà‚ïë ‚ïö‚ïê‚ïù ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù  ‚ñà‚ñà‚ïî‚ïù    ‚ñà‚ñà‚ïî‚ïù    ‚ñà‚ñà‚ïî‚ïù
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïù ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù

__version__ = (7, 7, 7, 0, 0, 0)
# meta developer: @shadow_mod777
# scope: disable_onload_docs
# packurl: https://raw.githubusercontent.com/Nyashka17/SHADOW_ULTIMAT/refs/heads/main/translations/Shadow_Ultimat.yml

import logging
import json
import urllib.request
import time
import asyncio
import typing
import re
import html
from telethon.tl.functions.messages import ReadMentionsRequest
from telethon.tl.functions.channels import InviteToChannelRequest, EditAdminRequest
from telethon.tl.types import ChatAdminRights

from ..inline.types import InlineCall
from .. import loader, utils

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logger = logging.getLogger("Shadow_Ultimat")

@loader.tds
class Shadow_Ultimat(loader.Module):
    """–ê—Ñ—Ç–æ —Ñ–∞—Ä–º –ë—Ñ–≥–± –æ—Ç #—Ç–µ–Ω–∏"""

    strings = {
        "name": "Shadow_Ultimat",
    }

    async def client_ready(self, client, db):
        self._client = client
        self._db = db
        self.shadowlib = await self.import_lib(
            "https://raw.githubusercontent.com/Nyashka17/SHADOW_ULTIMAT/refs/heads/main/libs/shadowlib.py",
            suspend_on_error=True,
        )
        self.prefix = self.db.get("hikka.main", "command_prefix", None) or self.db.get(
            "heroku.main", "command_prefix", "."
        )

    async def init(self):
        pass

    @loader.command()
    async def –≤–µ—Ä—Å–∏—è(self, message):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–µ—Ä—Å–∏—é –º–æ–¥—É–ª—è –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ"""
        updates = await self.shadowlib.updater.check_github_updates()

        if updates['available']:
            # –ü–æ–∫–∞–∑–∞—Ç—å inline —Ñ–æ—Ä–º—É
            await self.inline.form(
                message=message,
                text=f"üì¶ –î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: {updates['version']}\n\n"
                     f"üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è:\n{updates['changelog'][:300]}...",
                reply_markup=[
                    {
                        "text": "üîÑ –û–±–Ω–æ–≤–∏—Ç—å",
                        "callback": self.update_module_callback,
                        "args": (updates['version'],)
                    },
                    {"text": "‚ùå –û—Ç–º–µ–Ω–∞", "action": "close"}
                ]
            )
        else:
            current_version = self.shadowlib.version_mgr.get_current_version()
            await utils.answer(message, f"‚úÖ –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: {current_version}\n–û–±–Ω–æ–≤–ª–µ–Ω–∏–π –Ω–µ—Ç.")

    async def update_module_callback(self, call, version):
        """Callback –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–æ–¥—É–ª—è"""
        await utils.answer(call, "üîÑ –û–±–Ω–æ–≤–ª—è—é –º–æ–¥—É–ª—å...")

        result = await self.shadowlib.updater.update_module(version)

        await utils.answer(call, result)

    @loader.command()
    async def –≤–µ—Ä—Å–∏–∏(self, message):
        """–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–µ—Ä—Å–∏—è–º–∏ –º–æ–¥—É–ª—è"""
        current_version = self.shadowlib.version_mgr.get_current_version()
        updates = await self.shadowlib.updater.check_github_updates()
        backups = self.shadowlib.backuper.get_available_backups()

        text = f"üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏—è–º–∏\n\n–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: {current_version}"

        if updates['available']:
            text += f"\n\nüîÑ –î–æ—Å—Ç—É–ø–Ω–∞ –≤–µ—Ä—Å–∏—è: {updates['version']}"

        if backups:
            text += f"\n\nüîô –î–æ—Å—Ç—É–ø–Ω–æ –±—ç–∫–∞–ø–æ–≤: {len(backups)}"

        markup = [
            [
                {
                    "text": "üîÑ –û–±–Ω–æ–≤–∏—Ç—å",
                    "callback": self.show_update_menu,
                    "args": ()
                },
                {
                    "text": "üì¶ –í—ã–±—Ä–∞—Ç—å –≤–µ—Ä—Å–∏—é",
                    "callback": self.show_versions_list,
                    "args": (0,)  # page 0
                }
            ],
            [
                {
                    "text": f"üîô –û—Ç–∫–∞—Ç ({len(backups)})",
                    "callback": self.show_backups_menu,
                    "args": ()
                },
                {
                    "text": "‚ÑπÔ∏è –ò–Ω—Ñ–æ",
                    "callback": self.show_version_info,
                    "args": ()
                }
            ]
        ]

        await self.inline.form(
            message=message,
            text=text,
            reply_markup=markup
        )

    async def show_update_menu(self, call):
        """–ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"""
        updates = await self.shadowlib.updater.check_github_updates()

        if not updates['available']:
            await utils.answer(call, "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–π –Ω–µ—Ç")
            return

        text = f"üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ –≤–µ—Ä—Å–∏–∏ {updates['version']}\n\nüìù –ò–∑–º–µ–Ω–µ–Ω–∏—è:\n{updates['changelog'][:300]}..."

        markup = [
            {
                "text": "‚úÖ –û–±–Ω–æ–≤–∏—Ç—å",
                "callback": self.update_module_callback,
                "args": (updates['version'],)
            },
            {"text": "‚ùå –û—Ç–º–µ–Ω–∞", "action": "close"}
        ]

        await self.inline.form(
            call=call,
            text=text,
            reply_markup=markup
        )

    async def show_versions_list(self, call, page=0):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–µ—Ä—Å–∏–π"""
        versions = await self.shadowlib.github.get_available_versions()
        current = self.shadowlib.version_mgr.get_current_version()

        if not versions:
            await utils.answer(call, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π")
            return

        # –ü–∞–≥–∏–Ω–∞—Ü–∏—è: 5 –≤–µ—Ä—Å–∏–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
        per_page = 5
        start = page * per_page
        end = start + per_page
        page_versions = versions[start:end]

        text = f"üì¶ –î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ {page + 1})\n\n–¢–µ–∫—É—â–∞—è: {current}\n"

        markup = []
        for v in page_versions:
            status = "‚úÖ" if v['version'] == current else "‚¨ú"
            markup.append([
                {
                    "text": f"{status} {v['version']}",
                    "callback": self.show_version_details,
                    "args": (v['version'],)
                }
            ])

        # –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        nav_buttons = []
        if page > 0:
            nav_buttons.append({
                "text": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
                "callback": self.show_versions_list,
                "args": (page - 1,)
            })

        if end < len(versions):
            nav_buttons.append({
                "text": "–í–ø–µ—Ä—ë–¥ ‚û°Ô∏è",
                "callback": self.show_versions_list,
                "args": (page + 1,)
            })

        if nav_buttons:
            markup.append(nav_buttons)

        markup.append([{"text": "‚ùå –ó–∞–∫—Ä—ã—Ç—å", "action": "close"}])

        await self.inline.form(
            call=call,
            text=text,
            reply_markup=markup
        )

    async def show_version_details(self, call, version):
        """–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –≤–µ—Ä—Å–∏–∏"""
        versions = await self.shadowlib.github.get_available_versions()
        version_info = next((v for v in versions if v['version'] == version), None)

        if not version_info:
            await utils.answer(call, "‚ùå –í–µ—Ä—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            return

        text = f"üì¶ –í–µ—Ä—Å–∏—è {version}\n\nüìù {version_info['body'][:500]}...\n\nüîó {version_info['url']}"

        markup = [
            {
                "text": "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å",
                "callback": self.install_version_callback,
                "args": (version,)
            },
            {
                "text": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
                "callback": self.show_versions_list,
                "args": (0,)
            },
            {"text": "‚ùå –ó–∞–∫—Ä—ã—Ç—å", "action": "close"}
        ]

        await self.inline.form(
            call=call,
            text=text,
            reply_markup=markup
        )

    async def install_version_callback(self, call, version):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é"""
        await utils.answer(call, f"üîÑ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –≤–µ—Ä—Å–∏—é {version}...")

        result = await self.shadowlib.updater.install_specific_version(version)

        await utils.answer(call, result)

    async def show_backups_menu(self, call):
        """–ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é –±—ç–∫–∞–ø–æ–≤"""
        backups = self.shadowlib.backuper.get_available_backups()

        if not backups:
            await utils.answer(call, "‚ùå –ë—ç–∫–∞–ø–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
            return

        text = f"üîô –î–æ—Å—Ç—É–ø–Ω—ã–µ –±—ç–∫–∞–ø—ã ({len(backups)})\n\n–í—ã–±–µ—Ä–∏—Ç–µ –±—ç–∫–∞–ø –¥–ª—è –æ—Ç–∫–∞—Ç–∞:"

        markup = []
        for backup in backups[:5]:  # –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–≤—ã–µ 5
            timestamp = backup.replace('sh_backup_', '')
            markup.append([
                {
                    "text": f"üìÅ {timestamp}",
                    "callback": self.rollback_callback,
                    "args": (backup,)
                }
            ])

        markup.append([{"text": "‚ùå –ó–∞–∫—Ä—ã—Ç—å", "action": "close"}])

        await self.inline.form(
            call=call,
            text=text,
            reply_markup=markup
        )

    async def rollback_callback(self, call, backup_dir):
        """–û—Ç–∫–∞—Ç –∫ –±—ç–∫–∞–ø—É"""
        await utils.answer(call, f"üîÑ –í—ã–ø–æ–ª–Ω—è—é –æ—Ç–∫–∞—Ç –∫ {backup_dir}...")

        result = await self.shadowlib.backuper.rollback_to_backup(backup_dir)

        await utils.answer(call, result)

    async def show_version_info(self, call):
        """–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–µ—Ä—Å–∏–∏"""
        current = self.shadowlib.version_mgr.get_current_version()
        backups = self.shadowlib.backuper.get_available_backups()

        text = f"‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ—Ä—Å–∏–∏\n\nüì¶ –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: {current}\nüîô –ë—ç–∫–∞–ø–æ–≤: {len(backups)}\n\n–°—Ö–µ–º–∞ –≤–µ—Ä—Å–∏–π: 7.7.7.X.X.X\n–≥–¥–µ X –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ"

        markup = [
            {
                "text": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
                "callback": self.–≤–µ—Ä—Å–∏–∏,
                "args": (call.message,)  # –ü–µ—Ä–µ–¥–∞—ë–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ñ–æ—Ä–º—ã
            },
            {"text": "‚ùå –ó–∞–∫—Ä—ã—Ç—å", "action": "close"}
        ]

        await self.inline.form(
            call=call,
            text=text,
            reply_markup=markup
        )
